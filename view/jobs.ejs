<% layout("layout") %>

<div class="container mt-4">
    <!-- Header -->
    <h1 class="mb-4">Job Applications</h1>

    
    <div class="row mb-4 g-3 align-items-center">
        <div class="col-lg-3 col-md-6">
            <select id="domain-select" class="form-select bg-light border-0">
                <option selected value="">Domain</option>
                <option value="Software">Software</option>
                <option value="Marketing">Marketing</option>
                <option value="Data">Data Analyst</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-6">
            <select id="package-select" class="form-select bg-light border-0">
                <option selected value="">Package</option>
                <option value="1">3-5 LPA</option>
                <option value="2">5-8 LPA</option>
                <option value="3">8+ LPA</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-6">
            <select id="location-select" class="form-select bg-light border-0">
                <option selected value="">Location</option>
                <option value="Bangalore">Bangalore</option>
                <option value="Pune">Pune</option>
                <option value="Remote">Remote</option>
            </select>
        </div>
        <div class="col-lg-3 col-md-6">
            <button id="filter-button" class="btn btn-primary w-100">Apply Filters</button>
        </div>
    </div>


    <div id="job-listings" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <% jobs.forEach(job => { %>
        <div class="col job-card" 
             data-company-name="<%= job.companyName %>" 
             data-title="Software Engineer" 
             data-location="<%= job.location %>" 
             data-package="<%= job.package %>">
            <div class="card h-100 shadow-sm border-light">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold">Software Engineer - <%= job.companyName %></h5>
                    <p class="card-text small text-muted mb-2">
                        <i class="bi bi-geo-alt-fill"></i> <%= job.location %> | <i class="bi bi-box-seam"></i> <%= job.package %>
                    </p>
                    <p class="card-text small">
                        <strong>Eligibility:</strong> Min <%= job.eligibility.minCgpa %> CGPA, <%= job.eligibility.department.join(' / ') %>
                    </p>
                    <div class="mt-auto pt-3 d-grid gap-2 d-sm-flex">
                        <a href="/jobs/<%= job._id %>/apply" class="btn btn-primary flex-fill">Apply</a>
                        <a href="/jobs/<%=job._id%>" class="btn btn-outline-secondary flex-fill">View Details</a>
                    </div>
                </div>
            </div>
        </div>
        <% }); %>
    </div>
     <div id="no-jobs-message" class="col-12" style="display: none;">
        <div class="alert alert-light text-center" role="alert">
            No jobs found matching your criteria.
        </div>
    </div>
   <div class="my-5">
        <h2 class="mb-3">My Applications</h2>
        
        <% if(myApplications && myApplications.length > 0) { %>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                <% myApplications.forEach(app => { %>
                    <div class="col">
                        <div class="card h-100 shadow-sm border-light">
                            <div class="card-body">
                                <h5 class="card-title fw-bold"><%= app.job ? app.job.companyName : 'N/A' %></h5>
                                <p class="card-text text-muted"><%= app.job ? 'Software Engineer' : 'N/A' %></p>
                                <% let badgeClass = 'bg-secondary'; %>
                                <% if (app.status === 'Applied') badgeClass = 'bg-light text-dark'; %>
                                <% if (app.status === 'Under Review') badgeClass = 'bg-info text-dark'; %>
                                <% if (app.status === 'Shortlisted') badgeClass = 'bg-primary'; %>
                                <% if (app.status === 'Interview') badgeClass = 'bg-warning text-dark'; %>
                                <% if (app.status === 'Offered') badgeClass = 'bg-success'; %>
                                <% if (app.status === 'Rejected') badgeClass = 'bg-danger'; %>
                                <span class="badge rounded-pill <%= badgeClass %>"><%= app.status %></span>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="card shadow-sm border-light">
                 <div class="card-body text-center text-muted p-4">
                    You haven't applied to any jobs yet.
                </div>
            </div>
        <% } %>
    </div>
</div>
    

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const domainSelect = document.getElementById('domain-select');
        const packageSelect = document.getElementById('package-select');
        const locationSelect = document.getElementById('location-select');
        const filterButton = document.getElementById('filter-button');
        const jobCards = document.querySelectorAll('.job-card');
        const noJobsMessage = document.getElementById('no-jobs-message');

        const packageRanges = {
            "1": { min: 3, max: 5 },
            "2": { min: 5, max: 8 },
            "3": { min: 8, max: Infinity }
        };

        function applyFilters() {
            const selectedDomain = domainSelect.value;
            const selectedPackage = packageSelect.value;
            const selectedLocation = locationSelect.value;

            let visibleJobs = 0;

            jobCards.forEach(card => {
                const title = card.dataset.title.toLowerCase();
                const location = card.dataset.location;
                const jobPackageText = card.dataset.package;
                const jobPackageNum = parseFloat(jobPackageText);

                // Check domain
                const domainMatch = !selectedDomain || title.includes(selectedDomain.toLowerCase());

                // Check location
                const locationMatch = !selectedLocation || location === selectedLocation;

                // Check package
                let packageMatch = true;
                if (selectedPackage && packageRanges[selectedPackage]) {
                    const range = packageRanges[selectedPackage];
                    packageMatch = !isNaN(jobPackageNum) && jobPackageNum >= range.min && jobPackageNum < range.max;
                }

                if (domainMatch && locationMatch && packageMatch) {
                    card.style.display = '';
                    visibleJobs++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show or hide the "no jobs" message
            noJobsMessage.style.display = visibleJobs === 0 ? 'block' : 'none';
        }

        // Add click event listener to the button
        filterButton.addEventListener('click', applyFilters);
    });
</script>

